<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IELTS Writing Test</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    /* Smooth page feel */
    html { scroll-behavior: smooth; }
    .glass {
      background: rgba(255,255,255,0.75);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .mono { font-variant-numeric: tabular-nums; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100 text-slate-900">
  <!-- Top Bar -->
  <header class="sticky top-0 z-30 border-b border-slate-200 bg-white/70 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center shadow-sm">
          <i class="fa-solid fa-pen-nib"></i>
        </div>
        <div>
          <h1 class="text-lg font-semibold leading-tight">IELTS Writing Test</h1>
          <p class="text-xs text-slate-500">Task 1 + Task 2 ‚Ä¢ Submit to Telegram</p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button id="btnOpenLogin" class="hidden sm:inline-flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 text-sm hover:bg-slate-50">
          <i class="fa-solid fa-user"></i>
          <span id="studentBadgeTop">Set Student Info</span>
        </button>

        <button id="btnReset" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-3 py-2 text-sm text-white hover:bg-slate-800">
          <i class="fa-solid fa-rotate-right"></i>
          Reset
        </button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-6xl px-4 py-6 sm:py-10">
    <!-- Info / Status Row -->
    <section class="grid gap-4 md:grid-cols-3">
      <div class="glass rounded-2xl border border-slate-200 p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <p class="text-sm font-semibold">Student</p>
          <button id="btnEditStudent" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 px-3 py-2 text-xs hover:bg-white">
            <i class="fa-solid fa-pen"></i> Edit
          </button>
        </div>
        <div class="mt-3 space-y-1 text-sm">
          <p><span class="text-slate-500">Name:</span> <span id="sName">‚Äî</span></p>
          <p><span class="text-slate-500">Group:</span> <span id="sGroup">‚Äî</span></p>
          <p><span class="text-slate-500">Level:</span> <span id="sLevel">‚Äî</span></p>
        </div>
      </div>

      <div class="glass rounded-2xl border border-slate-200 p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <p class="text-sm font-semibold">Timer</p>
          <div class="text-xs text-slate-500">Suggested: 60 mins</div>
        </div>
        <div class="mt-3 flex items-end justify-between">
          <div>
            <div class="text-3xl font-semibold mono" id="timer">60:00</div>
            <div class="text-xs text-slate-500 mt-1" id="timerHint">Starts when you click ‚ÄúStart Test‚Äù.</div>
          </div>
          <div class="flex gap-2">
            <button id="btnStart" class="rounded-xl bg-emerald-600 px-3 py-2 text-xs font-semibold text-white hover:bg-emerald-700">
              <i class="fa-solid fa-play"></i> Start Test
            </button>
            <button id="btnPause" class="rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold hover:bg-white" disabled>
              <i class="fa-solid fa-pause"></i> Pause
            </button>
          </div>
        </div>
        <div class="mt-3">
          <div class="h-2 w-full overflow-hidden rounded-full bg-slate-200">
            <div id="timerBar" class="h-full w-0 bg-slate-900"></div>
          </div>
          <div class="mt-2 flex items-center justify-between text-xs text-slate-500">
            <span>Focus breaks: <span id="violations" class="font-semibold text-slate-700">0</span></span>
            <span id="autosave" class="italic">Autosave: off</span>
          </div>
        </div>
      </div>

      <div class="glass rounded-2xl border border-slate-200 p-4 shadow-sm">
        <p class="text-sm font-semibold">Submit</p>
        <p class="mt-2 text-xs text-slate-500">
          Your answers will be sent to Telegram via <span class="font-mono">/api/telegram</span>.
        </p>

        <div class="mt-4 flex gap-2">
          <button id="btnSubmit" class="flex-1 rounded-xl bg-indigo-600 px-3 py-2 text-sm font-semibold text-white hover:bg-indigo-700">
            <i class="fa-solid fa-paper-plane"></i> Submit Answers
          </button>
        </div>

        <div id="submitStatus" class="mt-3 hidden rounded-xl border border-slate-200 bg-white p-3 text-sm"></div>
      </div>
    </section>

    <!-- Tasks -->
    <section class="mt-6 grid gap-6">
      <!-- Task 1 -->
      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">
              Task 1
              <span class="ml-2 rounded-full bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-700">Academic</span>
            </h2>
            <p class="mt-2 text-sm text-slate-700">
              The charts below show the main reasons why students chose a particular university in the UK, in 1997 and 2007.
            </p>
            <p class="mt-2 text-xs text-slate-500">
              Image link: 
              <a class="text-indigo-600 underline" href="https://ibb.co/fzkTpJMj" target="_blank" rel="noreferrer">
                https://ibb.co/fzkTpJMj
              </a>
              (If the image doesn‚Äôt display below, open the link.)
            </p>
          </div>

          <div class="mt-2 sm:mt-0 flex items-center gap-2">
            <span class="rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white">
              Recommended: 20 mins
            </span>
            <span class="rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700">
              Min: 150 words
            </span>
          </div>
        </div>

        <div class="mt-4 grid gap-4 lg:grid-cols-2">
          <!-- Try embedding (may or may not work depending on host) -->
          <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold text-slate-700">Task 1 Chart</p>
              <a class="text-xs text-indigo-600 underline" href="https://ibb.co/fzkTpJMj" target="_blank" rel="noreferrer">
                Open
              </a>
            </div>
            <div class="mt-3 overflow-hidden rounded-xl border border-slate-200 bg-white">
              <img
                src="https://ibb.co/fzkTpJMj"
                alt="Task 1 charts"
                class="w-full object-contain"
                onerror="document.getElementById('imgWarn').classList.remove('hidden');"
              />
            </div>
            <div id="imgWarn" class="hidden mt-3 rounded-xl border border-amber-200 bg-amber-50 p-3 text-xs text-amber-800">
              The image host didn‚Äôt allow direct embedding. Please click ‚ÄúOpen‚Äù above to view the chart.
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between">
              <p class="text-sm font-semibold">Your Task 1 Answer</p>
              <p class="text-xs text-slate-500">
                Words: <span id="wc1" class="font-semibold text-slate-700">0</span>
              </p>
            </div>
            <textarea
              id="task1"
              class="mt-2 w-full min-h-[260px] rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm leading-relaxed outline-none focus:bg-white focus:ring-4 focus:ring-slate-200"
              placeholder="Write at least 150 words..."
            ></textarea>

            <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-slate-500">
              <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
                <i class="fa-solid fa-lightbulb"></i>
                Overview + key comparisons + data support
              </span>
              <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
                <i class="fa-solid fa-chart-column"></i>
                Use ‚Äúhigher/lower‚Äù, ‚Äúaccounted for‚Äù, ‚Äúrose/fell‚Äù
              </span>
            </div>
          </div>
        </div>
      </article>

      <!-- Task 2 -->
      <article class="rounded-2xl border border-slate-200 bg-white p-5 shadow-sm">
        <div class="flex flex-col gap-2 sm:flex-row sm:items-start sm:justify-between">
          <div>
            <h2 class="text-lg font-semibold">
              Task 2
              <span class="ml-2 rounded-full bg-slate-100 px-2 py-1 text-xs font-semibold text-slate-700">Essay</span>
            </h2>
            <p class="mt-2 text-sm text-slate-700">
              Some people think more public money should be spent on roads and motorways than the public transport system.
              To what extent do you agree or disagree?
            </p>
          </div>

          <div class="mt-2 sm:mt-0 flex items-center gap-2">
            <span class="rounded-xl bg-slate-900 px-3 py-2 text-xs font-semibold text-white">
              Recommended: 40 mins
            </span>
            <span class="rounded-xl border border-slate-200 px-3 py-2 text-xs font-semibold text-slate-700">
              Min: 250 words
            </span>
          </div>
        </div>

        <div class="mt-4">
          <div class="flex items-center justify-between">
            <p class="text-sm font-semibold">Your Task 2 Answer</p>
            <p class="text-xs text-slate-500">
              Words: <span id="wc2" class="font-semibold text-slate-700">0</span>
            </p>
          </div>
          <textarea
            id="task2"
            class="mt-2 w-full min-h-[320px] rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm leading-relaxed outline-none focus:bg-white focus:ring-4 focus:ring-slate-200"
            placeholder="Write at least 250 words..."
          ></textarea>

          <div class="mt-3 flex flex-wrap items-center gap-2 text-xs text-slate-500">
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
              <i class="fa-solid fa-sitemap"></i>
              Clear position + 2 strong paragraphs
            </span>
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
              <i class="fa-solid fa-link"></i>
              Use cohesive devices naturally
            </span>
            <span class="inline-flex items-center gap-2 rounded-full bg-slate-100 px-3 py-1">
              <i class="fa-solid fa-scale-balanced"></i>
              Compare costs, congestion, environment, equity
            </span>
          </div>
        </div>
      </article>
    </section>

    <!-- Footer Note -->
    <footer class="mt-8 text-center text-xs text-slate-500">
      <p>Tip: Don‚Äôt refresh the page. Your writing is autosaved locally once you start.</p>
    </footer>
  </main>

  <!-- Login Modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>

    <div class="relative mx-auto mt-20 w-[92%] max-w-lg rounded-3xl bg-white p-6 shadow-xl">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-lg font-semibold">Student Login</h3>
          <p class="mt-1 text-xs text-slate-500">Fill in the info before starting the test.</p>
        </div>
        <button id="btnCloseModal" class="rounded-xl border border-slate-200 px-3 py-2 text-xs hover:bg-slate-50">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <div class="mt-5 grid gap-3">
        <label class="text-xs font-semibold text-slate-700">Student Name</label>
        <input id="inName" type="text" class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm outline-none focus:bg-white focus:ring-4 focus:ring-slate-200" placeholder="e.g., Doniyor"/>

        <label class="text-xs font-semibold text-slate-700 mt-2">Group</label>
        <input id="inGroup" type="text" class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm outline-none focus:bg-white focus:ring-4 focus:ring-slate-200" placeholder="e.g., IELTS 7 PM"/>

        <label class="text-xs font-semibold text-slate-700 mt-2">Level</label>
        <input id="inLevel" type="text" class="rounded-2xl border border-slate-200 bg-slate-50 px-4 py-3 text-sm outline-none focus:bg-white focus:ring-4 focus:ring-slate-200" placeholder="e.g., IELTS / Pre-IELTS"/>
      </div>

      <div class="mt-6 flex items-center justify-between gap-2">
        <button id="btnClearInfo" class="rounded-xl border border-slate-200 px-4 py-3 text-sm font-semibold hover:bg-slate-50">
          Clear
        </button>
        <button id="btnSaveInfo" class="rounded-xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800">
          Save
        </button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    function wordCount(text) {
      const cleaned = (text || "")
        .replace(/\s+/g, " ")
        .trim();
      if (!cleaned) return 0;
      return cleaned.split(" ").length;
    }

    function nowStamp() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function setStatus(message, ok = true) {
      const box = $("submitStatus");
      box.classList.remove("hidden");
      box.className = "mt-3 rounded-xl border p-3 text-sm";
      if (ok) {
        box.classList.add("border-emerald-200", "bg-emerald-50", "text-emerald-900");
      } else {
        box.classList.add("border-rose-200", "bg-rose-50", "text-rose-900");
      }
      box.innerHTML = message;
    }

    // ---------- State ----------
    const STORAGE_KEY = "ielts_writing_test_v1";
    let violations = 0;

    // Timer (60 mins)
    const TOTAL_SECONDS = 60 * 60;
    let remaining = TOTAL_SECONDS;
    let timerHandle = null;
    let started = false;
    let paused = false;

    // ---------- Elements ----------
    const task1 = $("task1");
    const task2 = $("task2");

    // ---------- Modal ----------
    function openModal() { $("modal").classList.remove("hidden"); }
    function closeModal() { $("modal").classList.add("hidden"); }

    $("btnOpenLogin").addEventListener("click", openModal);
    $("btnEditStudent").addEventListener("click", openModal);
    $("btnCloseModal").addEventListener("click", closeModal);

    $("btnClearInfo").addEventListener("click", () => {
      $("inName").value = "";
      $("inGroup").value = "";
      $("inLevel").value = "";
    });

    function applyStudentInfo(name, group, level) {
      $("sName").textContent = name || "‚Äî";
      $("sGroup").textContent = group || "‚Äî";
      $("sLevel").textContent = level || "‚Äî";

      const badgeText = name ? `${name}` : "Set Student Info";
      $("studentBadgeTop").textContent = badgeText;

      $("btnOpenLogin").classList.remove("hidden");
    }

    $("btnSaveInfo").addEventListener("click", () => {
      const name = $("inName").value.trim();
      const group = $("inGroup").value.trim();
      const level = $("inLevel").value.trim();

      applyStudentInfo(name, group, level);
      saveLocal();
      closeModal();
    });

    // ---------- Autosave ----------
    function saveLocal() {
      const payload = {
        student: {
          name: $("sName").textContent === "‚Äî" ? "" : $("sName").textContent,
          group: $("sGroup").textContent === "‚Äî" ? "" : $("sGroup").textContent,
          level: $("sLevel").textContent === "‚Äî" ? "" : $("sLevel").textContent,
        },
        answers: {
          task1: task1.value,
          task2: task2.value
        },
        timer: { remaining, started, paused },
        violations
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      $("autosave").textContent = "Autosave: saved";
      setTimeout(() => {
        $("autosave").textContent = started ? "Autosave: on" : "Autosave: off";
      }, 800);
    }

    function loadLocal() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return;

        const payload = JSON.parse(raw);
        const st = payload.student || {};
        applyStudentInfo(st.name || "", st.group || "", st.level || "");

        const ans = payload.answers || {};
        task1.value = ans.task1 || "";
        task2.value = ans.task2 || "";

        const t = payload.timer || {};
        remaining = typeof t.remaining === "number" ? t.remaining : TOTAL_SECONDS;
        started = !!t.started;
        paused = !!t.paused;

        violations = payload.violations || 0;
        $("violations").textContent = violations;

        updateWordCounts();
        updateTimerUI();
        $("autosave").textContent = started ? "Autosave: on" : "Autosave: off";

        // If it was running and user reloaded, keep it paused to be safe
        if (started && !paused) {
          paused = true;
          updateTimerUI();
        }
      } catch (e) {}
    }

    function updateWordCounts() {
      $("wc1").textContent = wordCount(task1.value);
      $("wc2").textContent = wordCount(task2.value);
    }

    task1.addEventListener("input", () => { updateWordCounts(); if (started) saveLocal(); });
    task2.addEventListener("input", () => { updateWordCounts(); if (started) saveLocal(); });

    // ---------- Focus breaks (visibility change) ----------
    document.addEventListener("visibilitychange", () => {
      if (!started) return;
      if (document.hidden) {
        violations++;
        $("violations").textContent = violations;
        saveLocal();
      }
    });

    // ---------- Timer ----------
    function formatMMSS(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function updateTimerUI() {
      $("timer").textContent = formatMMSS(remaining);

      const used = TOTAL_SECONDS - remaining;
      const pct = Math.min(100, Math.max(0, (used / TOTAL_SECONDS) * 100));
      $("timerBar").style.width = pct + "%";

      $("btnStart").disabled = started && !paused;
      $("btnPause").disabled = !started;

      if (!started) {
        $("timerHint").textContent = "Starts when you click ‚ÄúStart Test‚Äù.";
      } else if (paused) {
        $("timerHint").textContent = "Paused.";
      } else {
        $("timerHint").textContent = "Running‚Ä¶";
      }

      $("autosave").textContent = started ? "Autosave: on" : "Autosave: off";
    }

    function tick() {
      if (paused) return;
      remaining = Math.max(0, remaining - 1);
      updateTimerUI();

      if (remaining === 0) {
        clearInterval(timerHandle);
        timerHandle = null;
        paused = true;
        updateTimerUI();
        setStatus("Time is up. You can still submit your answers.", true);
        saveLocal();
      }
    }

    $("btnStart").addEventListener("click", () => {
      // Require student info
      const name = $("sName").textContent;
      if (!name || name === "‚Äî") {
        openModal();
        setStatus("Please set Student Info first.", false);
        return;
      }

      started = true;
      paused = false;

      if (!timerHandle) {
        timerHandle = setInterval(tick, 1000);
      }

      updateTimerUI();
      saveLocal();
      setStatus("Test started. Good luck!", true);
    });

    $("btnPause").addEventListener("click", () => {
      if (!started) return;
      paused = !paused;
      updateTimerUI();
      saveLocal();
    });

    // ---------- Reset ----------
    $("btnReset").addEventListener("click", () => {
      const ok = confirm("Reset everything? This will clear answers and student info.");
      if (!ok) return;

      localStorage.removeItem(STORAGE_KEY);

      task1.value = "";
      task2.value = "";
      updateWordCounts();

      applyStudentInfo("", "", "");
      $("inName").value = "";
      $("inGroup").value = "";
      $("inLevel").value = "";

      violations = 0;
      $("violations").textContent = "0";

      started = false;
      paused = false;
      remaining = TOTAL_SECONDS;

      if (timerHandle) {
        clearInterval(timerHandle);
        timerHandle = null;
      }

      updateTimerUI();
      $("submitStatus").classList.add("hidden");
      $("autosave").textContent = "Autosave: off";
    });

    // ---------- Submit to Telegram ----------
    $("btnSubmit").addEventListener("click", async () => {
      const name = $("sName").textContent === "‚Äî" ? "" : $("sName").textContent;
      const group = $("sGroup").textContent === "‚Äî" ? "" : $("sGroup").textContent;
      const level = $("sLevel").textContent === "‚Äî" ? "" : $("sLevel").textContent;

      if (!name) {
        openModal();
        setStatus("Please set Student Info before submitting.", false);
        return;
      }

      const a1 = task1.value.trim();
      const a2 = task2.value.trim();

      const wc1 = wordCount(a1);
      const wc2 = wordCount(a2);

      if (!a1 || !a2) {
        setStatus("Please write answers for BOTH Task 1 and Task 2 before submitting.", false);
        return;
      }

      const msg =
`üìù IELTS Writing Submission
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üë§ Name: ${name}
üë• Group: ${group || "-"}
üéØ Level: ${level || "-"}
üïí Submitted: ${nowStamp()}
‚è±Ô∏è Time left: ${formatMMSS(remaining)}
‚ö†Ô∏è Focus breaks: ${violations}

‚úÖ Task 1 Prompt:
The charts below show the main reasons why students chose a particular university in the UK, in 1997 and 2007.
Chart link: https://ibb.co/fzkTpJMj

‚úçÔ∏è Task 1 Answer (${wc1} words):
${a1}

‚úÖ Task 2 Prompt:
Some people think more public money should be spent on roads and motorways than the public transport system. To what extent do you agree or disagree?

‚úçÔ∏è Task 2 Answer (${wc2} words):
${a2}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`;

      try {
        $("btnSubmit").disabled = true;
        $("btnSubmit").classList.add("opacity-70");

        setStatus("Sending to Telegram...", true);

        const res = await fetch("/api/telegram", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: msg })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data.success) {
          const err = data.error || `Request failed (${res.status})`;
          setStatus("‚ùå Failed to send. " + err, false);
          $("btnSubmit").disabled = false;
          $("btnSubmit").classList.remove("opacity-70");
          return;
        }

        setStatus("‚úÖ Submitted successfully! Your answers were sent to Telegram.", true);
        saveLocal();
      } catch (e) {
        setStatus("‚ùå Failed to send. " + (e?.message || "Unknown error"), false);
      } finally {
        $("btnSubmit").disabled = false;
        $("btnSubmit").classList.remove("opacity-70");
      }
    });

    // ---------- Init ----------
    loadLocal();
    updateWordCounts();
    updateTimerUI();

    // Open modal on first visit if no student name
    if ($("sName").textContent === "‚Äî") {
      $("btnOpenLogin").classList.remove("hidden");
      openModal();
    } else {
      $("btnOpenLogin").classList.remove("hidden");
    }
  </script>
</body>
</html>
